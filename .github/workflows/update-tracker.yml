name: Update BMNR Tracker

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]

# Security: Least privilege permissions
permissions:
  contents: write      # For committing data updates
  pages: write        # For GitHub Pages deployment
  id-token: write     # For OIDC token

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    # Security: Pin actions to specific SHA hashes for supply chain security
    - name: Checkout repository
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      with:
        persist-credentials: false  # Security: Don't persist credentials
    
    - name: Setup Python
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: '3.11'
        check-latest: true  # Security: Use latest patch version
    
    - name: Run tracker update with error handling
      id: tracker_update
      continue-on-error: false  # Fail loudly on errors
      run: |
        python3 fetch_and_generate.py
        echo "update_status=success" >> $GITHUB_OUTPUT
      env:
        # Security: Limit network access (no credentials needed for public API)
        PYTHONHTTPSVERIFY: 1
    
    - name: Verify generated files
      run: |
        # Security: Validate outputs before committing
        if [ ! -f "docs/index.html" ]; then
          echo "Error: HTML not generated"
          exit 1
        fi
        if [ ! -f "data/bmnr_data.csv" ]; then
          echo "Error: CSV not generated"
          exit 1
        fi
        echo "✓ All required files generated"
    
    - name: Check logs for errors
      if: always()
      run: |
        if [ -f "logs/tracker.log" ]; then
          echo "=== Recent Log Entries ===" 
          tail -20 logs/tracker.log || true
          
          # Check for critical errors
          if grep -i "CRITICAL\\|FATAL" logs/tracker.log; then
            echo "::warning::Critical errors detected in logs"
          fi
        fi
    
    - name: Commit and push if changed
      id: commit_changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Security: Only add specific files (not logs or secrets)
        git add docs/ data/ || true
        
        # Check if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          # Security: Sanitize commit message
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "Update BMNR tracker data [$TIMESTAMP]" \
                    -m "Auto-generated by secure workflow" \
                    -m "Build: ${{ github.run_id }}"
          git push
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "✓ Changes committed and pushed"
        fi
    
    - name: Deploy to GitHub Pages
      # Security: Pin to specific version with SHA
      uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847  # v3.9.3
      if: steps.commit_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
        force_orphan: true  # Security: Clean history on deployment branch
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
    
    - name: Upload logs artifact
      if: always()  # Upload even if job fails
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      with:
        name: tracker-logs-${{ github.run_id }}
        path: logs/
        retention-days: 7  # Security: Limit retention
        if-no-files-found: warn
